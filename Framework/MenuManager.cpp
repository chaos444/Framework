#include "MenuManager.h"

const char* MOVE_SOUND = "\x52\x49\x46\x46\xA0\x04\x00\x00\x57\x41\x56\x45\x66\x6D\x74\x20\x32\x00\x00\x00\x02\x00\x02\x00\x22\x56\x00\x00\x27\x57\x00\x00\x00\x04\x04\x00\x20\x00\xF4\x03\x07\x00\x00\x01\x00\x00\x00\x02\x00\xFF\x00\x00\x00\x00\xC0\x00\x40\x00\xF0\x00\x00\x00\xCC\x01\x30\xFF\x88\x01\x18\xFF\x66\x61\x63\x74\x04\x00\x00\x00\xA7\x02\x00\x00\x64\x61\x74\x61\x00\x04\x00\x00\x02\x02\x28\x00\x37\x00\x89\xFF\x6F\x01\x3D\x01\x76\x00\x4E\x64\x05\xBF\x1C\xC2\x0B\x70\x37\x80\x78\xE7\xFD\x50\xD4\xEB\x2F\x22\x71\xF4\xED\xFD\x4E\x16\xF0\x0F\xD0\x4D\x34\xC1\xFC\x20\x22\xF1\xCF\x0D\x20\x42\xE4\xED\x2E\x02\x00\x21\x02\x2F\x92\x08\x00\xF0\x00\x00\x20\xF2\x0F\x10\x01\x50\x24\xF1\xFE\xEF\x0D\x00\x00\xF0\x1E\x03\xF0\x6F\x27\xE1\x0E\x30\xE4\xDE\x0F\xE0\x3F\x82\xE8\x5F\x04\x10\x11\xF1\x0F\x00\x20\xD2\xDC\x0F\x50\xF4\xBE\x1C\x33\x14\xF0\x0F\x11\xF1\x0E\x10\xB1\xEA\x1F\x31\xD2\xED\x7F\x17\x00\xE0\x1F\x11\x00\x00\xE0\xCE\xED\x5E\x16\xF0\x0F\x40\x34\xF2\xFE\xEF\x3E\xF3\x1F\xD1\x8D\x0A\x20\x23\xE2\x1C\x32\x02\x00\x30\xD3\xBC\xED\x0E\x12\xD1\x5C\x06\xE0\x0E\x60\x15\xE1\xEE\x1F\x21\xE2\xFE\xFF\x0F\x30\x73\xF7\xDE\x2E\x43\x04\xD0\xFD\x00\x00\xF0\x0F\x11\x11\x41\xF4\x0F\x11\x01\xC0\xEC\x1F\x02\xB0\xEA\x2F\x42\x23\xE2\xEE\x7E\x47\x03\xDF\xEB\x2F\x02\xE0\xFE\x4F\x33\x03\xE0\x0E\x51\x35\x03\x9F\x08\x10\x01\xE0\x0E\x10\x31\x12\xF1\xFF\x10\x72\x05\xF0\xCF\x0B\x20\x12\xF1\xDF\x4D\x44\x33\xF3\x0E\x00\x00\xF0\xBF\xEA\x0E\x30\x03\xFF\x10\x71\x27\x01\xF0\x1F\x01\xE0\xDE\xAE\x0B\x22\x02\xF1\x0F\x61\x37\x03\xD0\x0D\x00\xF0\xCF\xEC\xFE\x40\x45\x02\x00\x30\x64\x05\xF0\x0F\x00\x01\xE0\xED\x0E\x31\x32\x43\x04\x20\x73\x07\xE0\xFE\x00\x10\xD1\xED\x2F\x63\x36\x13\x00\x10\x62\x06\xF0\xE0\x0E\x00\x00\xF0\xEF\x4F\x55\x34\xF3\x0F\x10\x21\xE2\xFD\xD0\xDE\x2F\x21\x32\xC3\x7C\x37\x23\x02\x20\x23\xD2\xAE\xFA\x30\xF4\x00\xF0\x5F\x35\x32\xF3\xCE\x3D\x34\x02\x80\x09\x00\x10\x01\x10\x02\xF0\x2F\x54\x14\xC0\x0B\x20\x22\x11\x00\x00\x00\x70\x16\x01\xFF\x3F\x04\x10\x31\x11\xC1\x2E\x73\x07\x00\x00\x51\x15\x00\xF0\x10\x02\x10\x12\x12\xD1\xEF\x70\x07\x00\x00\x40\x34\x12\x11\xF1\x10\xF2\x70\x07\x00\x10\x31\x54\x13\x10\x22\x13\x01\x20\x13\x12\x03\x61\xF5\x0F\x01\x10\x73\x07\x01\x00\x50\x06\x10\x01\x00\x31\x43\x33\xF3\x1E\x71\x17\xF1\x0F\x30\x66\xF3\xFE\x30\x24\xF1\x0F\x00\x00\x41\x04\x00\xE0\x20\x22\xC1\x0F\x20\x15\xD0\x5E\x45\x03\x00\x42\x44\x26\xF1\x00\x00\x00\x20\x01\x90\xFB\x60\x07\x00\x01\x00\x01\x00\x30\x14\xE1\xDF\x5F\x24\xE2\x0E\x31\x43\x15\x32\xE2\xCF\xFD\x50\xF7\xBF\x0E\x10\x03\x40\x56\x24\xF2\xFF\x50\x26\x01\xE0\x2F\x12\x01\x50\x24\xE1\x4E\x55\x04\xE0\x0D\x61\xF5\xEE\x0E\xF0\x20\x03\x20\x04\x00\x40\x64\x15\x01\x20\x13\x01\xF0\x0F\x12\x02\x3F\x05\xF1\x30\x72\x35\xE3\x0C\x60\x06\xE0\xBE\x0D\x12\x02\xF0\xED\x70\x37\x14\x01\x00\x00\x00\x10\xF2\xEE\x0E\x32\x05\x10\x72\x26\x32\x32\x13\x01\xE0\xEF\x80\xDB\x0C\x01\x11\x12\x21\x42\x03\x11\x13\x13\xD1\xFE\x10\xD1\x0E\x11\x32\x04\x51\x66\x14\x11\x12\x01\x00\x10\x21\xF3\xE0\x40\x46\x02\xD0\x5F\x35\x22\xF1\xCF\x0E\x51\x35\x12\x00\x00\x42\x45\x02\xB0\xEC\x1F\x23\x02\x10\x43\x76\x56\x13\x01\x00\x20\x23\xF2\xDE\x0D\x21\x12\x12\x12\x23\x02\x21\x42\x25\x01\x20\x12\xE0\x2F\x44\x53\x25\x02\x10\x31\x75\x45\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x4C\x49\x53\x54\x46\x00\x00\x00\x49\x4E\x46\x4F\x49\x43\x52\x44\x0B\x00\x00\x00\x31\x39\x39\x36\x2D\x30\x32\x2D\x30\x37\x00\x00\x49\x45\x4E\x47\x0D\x00\x00\x00\x42\x69\x6C\x6C\x20\x57\x6F\x6C\x66\x6F\x72\x64\x00\x00\x49\x53\x46\x54\x10\x00\x00\x00\x53\x6F\x75\x6E\x64\x20\x46\x6F\x72\x67\x65\x20\x34\x2E\x30\x00";


//-----------------------------------------------------------------------------
// MenuManager Constructor
//-----------------------------------------------------------------------------

MenuManager::MenuManager()
{
	menuNbrs = 0;
	mouseMovement = false;
	checkTime = clock();
}

//-----------------------------------------------------------------------------
// MenuManager create Menu
//-----------------------------------------------------------------------------

Menu* MenuManager::createMenu(int x, int y, int menuWidth, std::string menuTitle, bool isMovable, D3DCOLOR backgroundColor, D3DCOLOR textColor, D3DCOLOR selectedColor)
{
	Menu m;
	m.init(x, y, menuWidth, menuTitle, isMovable, backgroundColor, textColor, selectedColor);
	menuNbrs++;
	menuList.push_back(m);
	return &menuList[menuNbrs - 1];
}

//-----------------------------------------------------------------------------
// MenuManager PlaySound
//-----------------------------------------------------------------------------

void MenuManager::playSound()
{
	sndPlaySound((LPCSTR)MOVE_SOUND, SND_ASYNC | SND_MEMORY);
}

//-----------------------------------------------------------------------------
// MenuManager management of Movement
//-----------------------------------------------------------------------------


void MenuManager::menuMovement(int menuId)
{
	if (menuList[menuId].containsMouseCursor(cursorPos))
	{
		if (GetAsyncKeyState(0x01) && 0x8000)
		{
			if (!mouseMovement)
			{
				diffCursorPos.x = menuList[menuId].getX() - cursorPos.x;
				diffCursorPos.y = menuList[menuId].getY() - cursorPos.y;
				mouseMovement = true;
				moveSelectedMenu = menuId;
			}
		}
		else
		{
			mouseMovement = false;
		}
	}

	if (mouseMovement && menuId == moveSelectedMenu)
	{
		menuList[menuId].moveMenu(cursorPos.x + diffCursorPos.x, cursorPos.y + diffCursorPos.y);
	}
}

//-----------------------------------------------------------------------------
// MenuManager Render all MENUs
//-----------------------------------------------------------------------------


void MenuManager::Render()
{
	if (menuNbrs == 0) return;

	GetCursorPos(&cursorPos);
	ScreenToClient(Target.Window, &cursorPos);

	for (int i = 0; i < menuNbrs; i++)
	{
		menuList[i].drawGui();

		if (menuList[i].isMoveAllowed())
		{
			menuMovement(i);
		}

		if ((GetAsyncKeyState(0x01) && 8000) && (double)elapsedTime > 150)
		{
			if ((cursorPos.x >= (menuList[i].getX()))
				&& (cursorPos.x <= (menuList[i].getX() + MENU_CHECKBOX_SIZE))
				&& (cursorPos.y >= menuList[i].getY())
				&& (cursorPos.y <= menuList[i].getY() + MENU_CHECKBOX_SIZE))
			{
				menuList[i].deployed = !menuList[i].deployed;
				playSound();
				checkTime = clock();
			}
		}

		if (menuList[i].getItemsNbrs() == 0 || !menuList[i].deployed) continue;

		for (int j = 0; j < menuList[i].getItemsNbrs(); j++)
		{
			if ((GetAsyncKeyState(0x01) && 8000) && (double)elapsedTime > 150)
			{
				if ((cursorPos.x >= (menuList[i].getX() + menuList[i].getWitdh() - MENU_BORDER_RIGHT))
					&& (cursorPos.x <= (menuList[i].getX() + menuList[i].getWitdh() - MENU_CHECKBOX_SIZE))
					&& (cursorPos.y >= menuList[i].getY() + ((j + 1) * MENU_ITEM_SIZE))
					&& (cursorPos.y <= menuList[i].getY() + ((j + 1) * MENU_ITEM_SIZE) + MENU_CHECKBOX_SIZE))
				{
					if (menuList[i].itemsTab[j].type == ITEM_BOOL)
					{
						menuList[i].switchItem(menuList[i].itemsTab[j]);
						playSound();
						checkTime = clock();
					}
				}
			}
			menuList[i].drawItem(menuList[i].itemsTab[j]);
		}

	}

	elapsedTime = clock() - checkTime;


}
